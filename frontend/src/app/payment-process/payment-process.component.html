<div class="payment-container">
  
  <!-- Success Message Overlay -->
  @if (paymentSuccess) {
    <div class="success-overlay">
      <div class="success-modal">
        <div class="success-icon">
          <i class="fi fi-br-check-circle"></i>
        </div>
        <h2>¡Pago realizado correctamente!</h2>
        <p>Tu pedido #{{ orderNumber }} ha sido procesado con éxito.</p>
        <p class="success-total">Total pagado: {{ totalPaid | number:'1.2-2' }}€</p>
        <p class="success-message">Te hemos enviado los detalles de tu compra por correo electrónico.</p>
        <div class="success-actions">
          <button class="continue-shopping-btn" routerLink="/home">
            <i class="fi fi-br-shopping-bag"></i> Seguir comprando
          </button>
          <button class="view-order-btn" routerLink="/profile/orders">
            <i class="fi fi-br-package"></i> Ver mis pedidos
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Header -->
  <div class="payment-header" [class.blur-background]="paymentSuccess">
    <h1 class="payment-title">Finalizar compra</h1>
    <p class="payment-subtitle">Completa tu información de pago y envío</p>
  </div>

  <div class="payment-content" [class.blur-background]="paymentSuccess">
    <div class="payment-main">
      <form [formGroup]="paymentForm" (ngSubmit)="processPayment()">
        <div class="payment-section">
          <div class="section-header">
            <h2>Dirección de envío</h2>
            <span class="section-step">Paso 1 de 3</span>
          </div>

          <div class="address-form">
            <div class="form-group">
              <label for="fullName">Nombre completo</label>
              <div class="input-container">
                <i class="fi fi-br-user"></i>
                <input 
                  type="text" 
                  id="fullName" 
                  formControlName="fullName" 
                  placeholder="Nombre y apellidos"
                >
              </div>
              @if (submitted && f['fullName'].errors) {
                <div class="error-message">
                  @if (f['fullName'].errors['required']) {
                    <span>El nombre es obligatorio</span>
                  }
                </div>
              }
            </div>

            <div class="form-group">
              <label for="address">Dirección</label>
              <div class="input-container">
                <i class="fi fi-br-map-marker"></i>
                <input 
                  type="text" 
                  id="address" 
                  formControlName="address" 
                  placeholder="Calle, número, piso..."
                >
              </div>
              @if (submitted && f['address'].errors) {
                <div class="error-message">
                  @if (f['address'].errors['required']) {
                    <span>La dirección es obligatoria</span>
                  }
                </div>
              }
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="city">Ciudad</label>
                <div class="input-container">
                  <i class="fi fi-br-building"></i>
                  <input 
                    type="text" 
                    id="city" 
                    formControlName="city" 
                    placeholder="Ciudad"
                  >
                </div>
                @if (submitted && f['city'].errors) {
                  <div class="error-message">
                    @if (f['city'].errors['required']) {
                      <span>La ciudad es obligatoria</span>
                    }
                  </div>
                }
              </div>

              <div class="form-group">
                <label for="zipCode">Código postal</label>
                <div class="input-container">
                  <i class="fi fi-br-envelope"></i>
                  <input 
                    type="text" 
                    id="zipCode" 
                    formControlName="zipCode" 
                    placeholder="Código postal"
                  >
                </div>
                @if (submitted && f['zipCode'].errors) {
                  <div class="error-message">
                    @if (f['zipCode'].errors['required']) {
                      <span>El código postal es obligatorio</span>
                    }
                    @if (f['zipCode'].errors['pattern']) {
                      <span>Código postal inválido</span>
                    }
                  </div>
                }
              </div>
            </div>

            <div class="form-group">
              <label for="phone">Teléfono de contacto</label>
              <div class="input-container">
                <i class="fi fi-br-phone-call"></i>
                <input 
                  type="tel" 
                  id="phone" 
                  formControlName="phone" 
                  placeholder="Teléfono para el envío"
                >
              </div>
              @if (submitted && f['phone'].errors) {
                <div class="error-message">
                  @if (f['phone'].errors['required']) {
                    <span>El teléfono es obligatorio</span>
                  }
                  @if (f['phone'].errors['pattern']) {
                    <span>Formato de teléfono inválido</span>
                  }
                </div>
              }
            </div>
          </div>
        </div>

        <!-- Payment Method Section -->
        <div class="payment-section">
          <div class="section-header">
            <h2>Método de pago</h2>
            <span class="section-step">Paso 2 de 3</span>
          </div>

          <div class="payment-methods">
            <div class="payment-method" [class.selected]="paymentMethod === 'card'" (click)="selectPaymentMethod('card')">
              <div class="method-icon">
                <i class="fi fi-br-credit-card"></i>
              </div>
              <div class="method-details">
                <h3>Tarjeta de crédito/débito</h3>
                <p>Pago seguro con tarjeta</p>
              </div>
              <div class="method-selector">
                <div class="radio-button"></div>
              </div>
            </div>

            <div class="payment-method" [class.selected]="paymentMethod === 'paypal'" (click)="selectPaymentMethod('paypal')">
              <div class="method-icon paypal">
                <i class="fi fi-brands-paypal"></i>
              </div>
              <div class="method-details">
                <h3>PayPal</h3>
                <p>Pago rápido y seguro</p>
              </div>
              <div class="method-selector">
                <div class="radio-button"></div>
              </div>
            </div>
          </div>

        <!-- Card Details Form -->
        @if (paymentMethod === 'card') {
          <div class="card-details">
            <!-- Tarjetas guardadas -->
            <div class="saved-cards" *ngIf="savedPaymentMethods && savedPaymentMethods.length > 0">
              <h3 class="saved-cards-title">Tus tarjetas guardadas</h3>
              <div class="saved-cards-list">
                @for (card of savedPaymentMethods; track card.id) {
                  <div class="saved-card-item" [class.selected]="selectedCardId === card.id" (click)="selectSavedCard(card)">
                    <div class="card-icon">
                      <i [class]="getCardIcon(card.type)"></i>
                    </div>
                    <div class="card-info">
                      <p class="card-name">{{ card.name }}</p>
                      <p class="card-number">**** {{ card.last4 }}</p>
                      <p class="card-expiry">Caduca: {{ card.expiry }}</p>
                    </div>
                    <div class="card-select">
                      <div class="radio-button"></div>
                    </div>
                  </div>
                }
              </div>
              
              <div class="divider">
                <span>o</span>
              </div>
              
              <button type="button" class="add-new-card-btn" (click)="useNewCard()">
                <i class="fi fi-br-plus"></i> Usar nueva tarjeta
              </button>
            </div>

            <!-- Formulario de nueva tarjeta -->
              @if (!selectedCardId || !savedPaymentMethods || savedPaymentMethods.length === 0) {
                <div class="form-group">
                  <label for="cardName">Nombre en la tarjeta</label>
                  <div class="input-container">
                    <i class="fi fi-br-user"></i>
                    <input 
                      type="text" 
                      id="cardName" 
                      formControlName="cardName" 
                      placeholder="Nombre que aparece en la tarjeta"
                    >
                  </div>
                  @if (submitted && f['cardName'].errors) {
                    <div class="error-message">
                      @if (f['cardName'].errors['required']) {
                        <span>El nombre en la tarjeta es obligatorio</span>
                      }
                    </div>
                  }
                </div>

                <div class="form-group">
                  <label for="cardNumber">Número de tarjeta</label>
                  <div class="input-container">
                    <i class="fi fi-br-credit-card"></i>
                    <input 
                      type="text" 
                      id="cardNumber" 
                      formControlName="cardNumber" 
                      placeholder="1234 5678 9012 3456"
                      maxlength="19"
                      (input)="formatCardNumber($event)"
                    >
                  </div>
                  @if (submitted && f['cardNumber'].errors) {
                    <div class="error-message">
                      @if (f['cardNumber'].errors['required']) {
                        <span>El número de tarjeta es obligatorio</span>
                      }
                      @if (f['cardNumber'].errors['pattern']) {
                        <span>Número de tarjeta inválido</span>
                      }
                    </div>
                  }
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="expiryDate">Fecha de caducidad</label>
                    <div class="input-container">
                      <i class="fi fi-br-calendar"></i>
                      <input 
                        type="text" 
                        id="expiryDate" 
                        formControlName="expiryDate" 
                        placeholder="MM/AA"
                        maxlength="5"
                        (input)="formatExpiryDate($event)"
                      >
                    </div>
                    @if (submitted && f['expiryDate'].errors) {
                      <div class="error-message">
                        @if (f['expiryDate'].errors['required']) {
                          <span>La fecha de caducidad es obligatoria</span>
                        }
                        @if (f['expiryDate'].errors['pattern']) {
                          <span>Formato inválido (MM/AA)</span>
                        }
                      </div>
                    }
                  </div>

                  <div class="form-group">
                    <label for="cvv">CVV</label>
                    <div class="input-container">
                      <i class="fi fi-br-lock"></i>
                      <input 
                        type="password" 
                        id="cvv" 
                        formControlName="cvv" 
                        placeholder="123"
                        maxlength="3"
                      >
                    </div>
                    @if (submitted && f['cvv'].errors) {
                      <div class="error-message">
                        @if (f['cvv'].errors['required']) {
                          <span>El CVV es obligatorio</span>
                        }
                        @if (f['cvv'].errors['pattern']) {
                          <span>CVV inválido</span>
                        }
                      </div>
                    }
                  </div>
                </div>
                
                <div class="form-group checkbox-group">
                  <label class="checkbox-container">
                    <input type="checkbox" formControlName="saveCard">
                    <span class="checkmark"></span>
                    <span>Guardar esta tarjeta para futuras compras</span>
                  </label>
                </div>
              }
            </div>
          }
        </div>

        <!-- Review Order Section -->
        <div class="payment-section">
          <div class="section-header">
            <h2>Revisar pedido</h2>
            <span class="section-step">Paso 3 de 3</span>
          </div>

          <div class="order-review">
            <div class="review-items">
              <h3>Productos en tu pedido</h3>
              
              @for (item of cartItems; track item.id) {
                <div class="review-item">
                  <div class="item-image">
                    <img [src]="item.url" [alt]="item.name">
                  </div>
                  <div class="item-details">
                    <h4>{{ item.name }}</h4>
                    <p>Cantidad: {{ item.quantity }}</p>
                  </div>
                  <div class="item-price">
                    @if (item.discount) {
                      <div class="price-container">
                        <div class="price-details">
                          <span class="price-label">Precio unitario:</span>
                          <span class="original-price">{{ item.price }}€</span>
                          <span class="unit-price">{{ (item.price - (item.price * item.discount / 100)) | number:'1.2-2' }}€/ud</span>
                        </div>
                        <div class="price-details">
                          <span class="price-label">Total:</span>
                          <span class="total-price discounted-price">{{ getItemTotal(item) | number:'1.2-2' }}€</span>
                        </div>
                      </div>
                    } @else {
                      <div class="price-container">
                        <div class="price-details">
                          <span class="price-label">Precio unitario:</span>
                          <span class="unit-price regular-price">{{ item.price }}€/ud</span>
                        </div>
                        <div class="price-details">
                          <span class="price-label">Total:</span>
                          <span class="total-price regular-price">{{ item.price * item.quantity | number:'1.2-2' }}€</span>
                        </div>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>

            <div class="terms-agreement">
              <div class="form-group checkbox-group">
                <label class="checkbox-container">
                  <input type="checkbox" formControlName="termsAccepted">
                  <span class="checkmark"></span>
                  <span>He leído y acepto los términos y condiciones y la política de privacidad</span>
                </label>
                @if (submitted && f['termsAccepted'].errors) {
                  <div class="error-message">
                    @if (f['termsAccepted'].errors['required']) {
                      <span>Debes aceptar los términos y condiciones</span>
                    }
                  </div>
                }
              </div>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="payment-actions">
          <button type="button" class="back-button" routerLink="/home/cart">
            <i class="fi fi-br-angle-left"></i> Volver al carrito
          </button>
          <button type="submit" class="pay-button" [disabled]="isProcessing">
            @if (!isProcessing) {
              <span>Pagar {{ calculateTotal() | number:'1.2-2' }}€</span>
            } @else {
              <span>Procesando...</span>
            }
          </button>
        </div>
      </form>
    </div>

    <!-- Order Summary Sidebar -->
    <div class="payment-summary">
      <h2 class="summary-title">Resumen del pedido</h2>
      
      <div class="summary-row">
        <span>Subtotal ({{ getTotalItems() }} productos)</span>
        <span>{{ getSubtotal() | number:'1.2-2' }}€</span>
      </div>
      
      @if (getTotalDiscount() > 0) {
        <div class="summary-row discount">
          <span>Descuento</span>
          <span>-{{ getTotalDiscount() | number:'1.2-2' }}€</span>
        </div>
      }
      
      <div class="summary-row shipping">
        <span>Envío</span>
        @if (getSubtotal() >= 50) {
          <span>Gratis</span>
        } @else {
          <span>3.99€</span>
        }
      </div>
      
      <div class="summary-divider"></div>
      
      <div class="summary-row total">
        <span>Total</span>
        <span>{{ calculateTotal() | number:'1.2-2' }}€</span>
      </div>

      <div class="secure-payment-info">
        <div class="secure-icon">
          <i class="fi fi-br-shield-check"></i>
        </div>
        <p>Pago 100% seguro. Tus datos están protegidos con encriptación SSL.</p>
      </div>
    </div>
  </div>
</div>