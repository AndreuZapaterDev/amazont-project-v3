<div class="payment-container">
  <div class="payment-header">
    <h1 class="payment-title">Finalizar compra</h1>
    <div class="steps-indicator">
      <div class="step" [class.active]="currentStep === 'shipping'" [class.completed]="currentStep === 'payment' || currentStep === 'confirmation'">
        <span class="step-number">1</span>
        <span class="step-name">Envío</span>
      </div>
      <div class="step-separator"></div>
      <div class="step" [class.active]="currentStep === 'payment'" [class.completed]="currentStep === 'confirmation'">
        <span class="step-number">2</span>
        <span class="step-name">Pago</span>
      </div>
      <div class="step-separator"></div>
      <div class="step" [class.active]="currentStep === 'confirmation'" [class.completed]="orderCompleted">
        <span class="step-number">3</span>
        <span class="step-name">Confirmación</span>
      </div>
    </div>
  </div>

  <div class="payment-content">
    <!-- Formulario de dirección de envío -->
    @if (currentStep === 'shipping') {
      <div class="payment-form-section shipping-form">
        <h2>Dirección de envío</h2>
        <form [formGroup]="shippingForm" (ngSubmit)="nextStep()">
          <div class="form-group">
            <label for="fullName">Nombre completo</label>
            <input type="text" id="fullName" formControlName="fullName" placeholder="Nombre y apellidos">
            @if (sf['fullName'].touched && sf['fullName'].errors?.['required']) {
              <div class="error-message">El nombre completo es obligatorio</div>
            }
          </div>

          <div class="form-group">
            <label for="address">Dirección</label>
            <input type="text" id="address" formControlName="address" placeholder="Calle, número, piso">
            @if (sf['address'].touched && sf['address'].errors?.['required']) {
              <div class="error-message">La dirección es obligatoria</div>
            }
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="city">Ciudad</label>
              <input type="text" id="city" formControlName="city" placeholder="Ciudad">
              @if (sf['city'].touched && sf['city'].errors?.['required']) {
                <div class="error-message">La ciudad es obligatoria</div>
              }
            </div>

            <div class="form-group">
              <label for="postalCode">Código postal</label>
              <input type="text" id="postalCode" formControlName="postalCode" placeholder="28000">
              @if (sf['postalCode'].touched && sf['postalCode'].errors?.['required']) {
                <div class="error-message">El código postal es obligatorio</div>
              }
              @if (sf['postalCode'].touched && sf['postalCode'].errors?.['pattern']) {
                <div class="error-message">El código postal debe tener 5 dígitos</div>
              }
            </div>
          </div>

          <div class="form-group">
            <label for="phone">Teléfono de contacto</label>
            <input type="tel" id="phone" formControlName="phone" placeholder="612345678">
            @if (sf['phone'].touched && sf['phone'].errors?.['required']) {
              <div class="error-message">El teléfono es obligatorio</div>
            }
            @if (sf['phone'].touched && sf['phone'].errors?.['pattern']) {
              <div class="error-message">El teléfono debe tener 9 dígitos</div>
            }
          </div>

          <div class="form-actions">
            <a routerLink="/home/cart" class="back-button">
              <i class="fi fi-br-angle-left"></i> Volver al carrito
            </a>
            <button type="submit" class="next-button">
              Continuar al pago <i class="fi fi-br-angle-right"></i>
            </button>
          </div>
        </form>
      </div>
    }

    <!-- Formulario de métodos de pago -->
    @if (currentStep === 'payment') {
      <div class="payment-form-section payment-method-form">
        <h2>Método de pago</h2>
        <form [formGroup]="paymentForm" (ngSubmit)="nextStep()">
          <div class="payment-methods">
            <div class="payment-method-selector">
              <label>
                <input type="radio" formControlName="paymentMethod" value="credit">
                <span class="payment-method-label">
                  <i class="fi fi-br-credit-card"></i> Tarjeta de crédito
                </span>
              </label>
            </div>
            
            <div class="payment-method-selector">
              <label>
                <input type="radio" formControlName="paymentMethod" value="paypal">
                <span class="payment-method-label">
                  <i class="fi fi-brands-paypal"></i> PayPal
                </span>
              </label>
            </div>
            
            <div class="payment-method-selector">
              <label>
                <input type="radio" formControlName="paymentMethod" value="bizum">
                <span class="payment-method-label">
                  <i class="fi fi-br-smartphone"></i> Bizum
                </span>
              </label>
            </div>
          </div>

          @if (pf['paymentMethod'].value === 'credit') {
            <div class="credit-card-form">
              <div class="form-group">
                <label for="cardHolder">Titular de la tarjeta</label>
                <input type="text" id="cardHolder" formControlName="cardHolder" placeholder="Nombre del titular">
                @if (pf['cardHolder'].touched && pf['cardHolder'].errors?.['required']) {
                  <div class="error-message">El nombre del titular es obligatorio</div>
                }
              </div>

              <div class="form-group">
                <label for="cardNumber">Número de tarjeta</label>
                <input type="text" id="cardNumber" formControlName="cardNumber" placeholder="1234 5678 9012 3456">
                @if (pf['cardNumber'].touched && pf['cardNumber'].errors?.['required']) {
                  <div class="error-message">El número de tarjeta es obligatorio</div>
                }
                @if (pf['cardNumber'].touched && pf['cardNumber'].errors?.['pattern']) {
                  <div class="error-message">El número de tarjeta debe tener 16 dígitos</div>
                }
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="expiryDate">Fecha de caducidad</label>
                  <input type="text" id="expiryDate" formControlName="expiryDate" placeholder="MM/YY">
                  @if (pf['expiryDate'].touched && pf['expiryDate'].errors?.['required']) {
                    <div class="error-message">La fecha de caducidad es obligatoria</div>
                  }
                  @if (pf['expiryDate'].touched && pf['expiryDate'].errors?.['pattern']) {
                    <div class="error-message">Formato incorrecto (MM/YY)</div>
                  }
                </div>

                <div class="form-group">
                  <label for="cvv">CVV</label>
                  <input type="text" id="cvv" formControlName="cvv" placeholder="123">
                  @if (pf['cvv'].touched && pf['cvv'].errors?.['required']) {
                    <div class="error-message">El CVV es obligatorio</div>
                  }
                  @if (pf['cvv'].touched && pf['cvv'].errors?.['pattern']) {
                    <div class="error-message">El CVV debe tener 3 o 4 dígitos</div>
                  }
                </div>
              </div>
            </div>
          }

          @if (pf['paymentMethod'].value === 'paypal') {
            <div class="payment-message">
              <p>Serás redirigido a PayPal para completar el pago de manera segura.</p>
            </div>
          }

          @if (pf['paymentMethod'].value === 'bizum') {
            <div class="payment-message">
              <p>Recibirás una notificación en tu app de Bizum para confirmar el pago.</p>
            </div>
          }

          <div class="form-actions">
            <button type="button" class="back-button" (click)="previousStep()">
              <i class="fi fi-br-angle-left"></i> Volver a envío
            </button>
            <button type="submit" class="next-button">
              Confirmar compra <i class="fi fi-br-angle-right"></i>
            </button>
          </div>
        </form>
      </div>
    }

    <!-- Confirmación de compra -->
    @if (currentStep === 'confirmation') {
      <div class="payment-confirmation">
        <div class="confirmation-success">
          <div class="success-icon">
            <i class="fi fi-br-check"></i>
          </div>
          <h2>¡Compra realizada con éxito!</h2>
          <p>Gracias por tu compra. Hemos enviado un email de confirmación a tu correo electrónico.</p>
          
          <div class="order-details">
            <h3>Detalles del pedido</h3>
            <p><strong>Número de pedido:</strong> #{{ orderNumber }}</p>
            <p><strong>Fecha:</strong> {{ getFormattedDate() }}</p>
            <p><strong>Método de pago:</strong> {{ getPaymentMethodText() }}</p>
            <p><strong>Total:</strong> {{ formatPrice(total) }}€</p>
          </div>
          
          <button class="continue-button" (click)="continueShopping()">
            Volver a la tienda <i class="fi fi-br-angle-right"></i>
          </button>
        </div>
      </div>
    }

    <!-- Resumen del pedido (siempre visible excepto en confirmación) -->
    @if (currentStep !== 'confirmation') {
      <div class="order-summary">
        <h2>Resumen del pedido</h2>
        
        <div class="summary-products">
          @for (item of cartItems; track item.id) {
            <div class="summary-product">
              <div class="product-image">
                <img [src]="item.url" [alt]="item.name">
                <span class="product-quantity">{{ item.quantity }}</span>
              </div>
              <div class="product-info">
                <h4>{{ item.name }}</h4>
                @if (!item.discount) {
                  <div class="product-price">{{ formatPrice(item.price) }}€</div>
                } @else {
                  <div class="product-price">
                    <span class="original-price">{{ formatPrice(item.price) }}€</span>
                    <span class="discounted-price">{{ formatPrice(getDiscountedPrice(item)) }}€</span>
                  </div>
                }
              </div>
            </div>
          }
        </div>
        
        <div class="summary-totals">
          <div class="summary-row">
            <span>Subtotal</span>
            <span>{{ formatPrice(subtotal) }}€</span>
          </div>
          
          @if (totalDiscount > 0) {
            <div class="summary-row">
              <span>Descuento</span>
              <span>-{{ formatPrice(totalDiscount) }}€</span>
            </div>
          }
          
          <div class="summary-row">
            <span>Envío</span>
            @if (shipping === 0) {
              <span>Gratis</span>
            } @else {
              <span>{{ formatPrice(shipping) }}€</span>
            }
          </div>
          
          <div class="summary-divider"></div>
          
          <div class="summary-row total">
            <span>Total</span>
            <span>{{ formatPrice(total) }}€</span>
          </div>
        </div>
      </div>
    }
  </div>
</div>